steps:
  build-docs:
    # build the docs in /docs with mkdocs and
    # add the .domains file for codeberg pages
    image: squidfunk/mkdocs-material
    commands:
      - mkdocs build -f ./mkdocs.yml -d docs_build
      - git switch --orphan pages
      - mv docs_build/* .
      - echo -e 'openfindata.org\nopenfindata.codeberg.page\npages.openfindata.codeberg.page' > .domains
    when:
      path:
        include:
          - 'mkdocs.yml'
          - 'docs/**'

  deploy-docs:
    # Push the resulting files to openfindata/pages
    # to deploy
    name: Push built docs to codeberg pages
    image: appleboy/drone-git-push
    settings:
      branch: main
      remote: git@codeberg.org:openfindata/pages.git
      force: true
      commit: true
      ssh_key:
        # created using woodpecker cli with:
        # woodpecker secret add -repository openfindata/openfindata \
        # -name codeberg_push_from_ci_priv_key -value @<path_to_privkey_file>
        from_secret: codeberg_push_from_ci_priv_key
    when:
      path:
        include:
          - 'mkdocs.yml'
          - 'docs/**'